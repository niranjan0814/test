# Authentication Flow - Role & Permission System

## Overview
The authentication system now uses **Spatie Laravel Permission** package to manage roles and permissions through proper database relationships.

## Database Structure

### Tables
1. **users** - User accounts
2. **roles** - Available roles (managed by Spatie)
3. **permissions** - Available permissions (managed by Spatie)
4. **role_has_permissions** - Links roles to permissions
5. **model_has_roles** - Links users to roles
6. **model_has_permissions** - Direct user permissions (optional)

## Authentication Flow

### 1. Login Request
**Endpoint:** `POST /api/auth/login`

**Request:**
```json
{
  "login": "SA0001",
  "password": "S@1234admin"
}
```

**Response:**
```json
{
  "statusCode": 2000,
  "message": "Login successful",
  "data": {
    "access_token": "3|OGHaLYqlFT7...",
    "token_type": "Bearer",
    "user": {
      "id": 1,
      "user_name": "SA0001",
      "email": "admin@fincore.com",
      "is_active": true,
      ...
    },
    "roles": [
      {
        "id": 1,
        "name": "super_admin",
        "display_name": "Super Administrator",
        "description": "Has full system access",
        "level": "super_admin"
      }
    ],
    "permissions": [
      {
        "id": 1,
        "name": "dashboard.view",
        "display_name": "View Dashboard",
        "module": "dashboard"
      },
      {
        "id": 2,
        "name": "users.view",
        "display_name": "View Users",
        "module": "users"
      },
      // ... all other permissions
    ]
  }
}
```

### 2. Get User Profile
**Endpoint:** `GET /api/auth/me`

**Headers:**
```
Authorization: Bearer {access_token}
```

**Response:** Same structure as login response

### 3. Logout
**Endpoint:** `POST /api/auth/logout`

**Headers:**
```
Authorization: Bearer {access_token}
```

**Response:**
```json
{
  "statusCode": 2000,
  "message": "Logout successful"
}
```

## How It Works

### Step 1: User Login
1. User sends credentials (username/email + password)
2. System validates credentials
3. System checks if account is active/locked
4. On success, creates authentication token

### Step 2: Load Roles
1. System loads user's roles from `model_has_roles` table
2. Uses Spatie's `HasRoles` trait on User model
3. Returns role details (name, display_name, level, etc.)

### Step 3: Load Permissions
1. System loads ALL permissions user has access to
2. Includes permissions from roles (via `role_has_permissions`)
3. Also includes direct user permissions (if any)
4. Uses Spatie's `getAllPermissions()` method

### Step 4: Return Complete Data
Returns:
- User details
- Access token
- All roles user belongs to
- All permissions user has (consolidated from all sources)

## Available Roles (Seeded)

1. **super_admin**
   - Full system access
   - All permissions
   - Hierarchy: 1 (highest)

2. **admin**
   - Administrative access
   - Most permissions (except permission management)
   - Hierarchy: 10

3. **staff**
   - Basic staff access
   - Limited permissions
   - Hierarchy: 100 (lowest)
   - Default role for new users

## Permission Modules

Permissions are organized by module:
- `dashboard` - Dashboard access
- `users` - User management
- `roles` - Role management
- `permissions` - Permission management
- `admins` - Admin management
- `staff` - Staff management
- `customers` - Customer management
- `branches` - Branch management
- `centers` - Center management
- `groups` - Group management
- `loan_products` - Loan product management
- `investment_products` - Investment product management

## Permission Naming Convention

Permissions follow this pattern: `{module}.{action}`

Examples:
- `users.view` - View users
- `users.create` - Create users
- `users.edit` - Edit users
- `users.delete` - Delete users
- `roles.view` - View roles
- `permissions.create` - Create permissions

## Code Implementation

### User Model
```php
use Spatie\Permission\Traits\HasRoles;

class User extends Authenticatable
{
    use HasRoles;
    
    // The trait provides:
    // - hasRole()
    // - hasPermissionTo()
    // - getAllPermissions()
    // - getRoleNames()
    // - and many more...
}
```

### Login Method
```php
// Load relationships
$user->load(['roles.permissions', 'permissions']);

// Map roles
$roles = $user->roles->map(function ($role) {
    return [
        'id' => $role->id,
        'name' => $role->name,
        'display_name' => $role->display_name,
        'description' => $role->description,
        'level' => $role->level,
    ];
});

// Map permissions (from all sources)
$permissions = $user->getAllPermissions()->map(function ($permission) {
    return [
        'id' => $permission->id,
        'name' => $permission->name,
        'display_name' => $permission->display_name,
        'module' => $permission->module,
    ];
});
```

## Testing with Postman

### 1. Login
```
POST http://127.0.0.1:8000/api/auth/login
Content-Type: application/json

{
  "login": "SA0001",
  "password": "S@1234admin"
}
```

### 2. Get Profile
```
GET http://127.0.0.1:8000/api/auth/me
Authorization: Bearer {token_from_login}
```

### 3. Check Permission
```
POST http://127.0.0.1:8000/api/auth/check-permission
Authorization: Bearer {token_from_login}
Content-Type: application/json

{
  "permission": "users.view"
}
```

### 4. Logout
```
POST http://127.0.0.1:8000/api/auth/logout
Authorization: Bearer {token_from_login}
```

## Benefits of This Flow

1. **Centralized Permission Management** - All permissions managed through Spatie
2. **Role-Based Access Control** - Users inherit permissions from roles
3. **Flexible** - Can assign direct permissions to users if needed
4. **Performance** - Efficient eager loading of relationships
5. **Consistent** - Same structure for login and profile endpoints
6. **Frontend Ready** - Complete role and permission data on login

## Next Steps

You can now:
- Use permissions in middleware: `middleware('permission:users.view')`
- Check permissions in controllers: `$user->hasPermissionTo('users.edit')`
- Check roles: `$user->hasRole('admin')`
- Gate authorization: `Gate::allows('users.create')`
